<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<div layout:fragment="content">
    <div id="content" class="sub-page clusters">
        <article class="location">
            <ul>
                <li><a onclick="movePage(URI_CP_FAULTINJECTION_EXPERIMENTS)">FaultInjection</a></li>
                <li><a onclick="movePage(URI_CP_FAULTINJECTION_EXPERIMENTS)">Experiments</a></li>
            </ul>
        </article>
        <article class="base tab-cont-wrap">
            <!-- tab btn -->
            <ul class="tab-btn">
                <!-- 활성화시 active 클래스 추가 -->
                <li type="podFault"><a href="javascript:">Pod Fault</a></li>
                <li type="networkAttack"><a href="javascript:">Network Attack</a></li>
                <li type="stressTest"><a href="javascript:">Stress Test</a></li>
            </ul>
            <!-- // tab btn -->
            <!-- tab content -->
            <div class="creat tab-content">
                <!-- Pod Fault -->
                <div>
                    <dl>
                        <dt><label for="namePod">Name</label></dt>
                        <dd>
                            <input class="name" id="namePod" type="text"  th:placeholder="#{M0876}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Namespace Selector</label></dt>
                        <dd>
                            <fieldset>
                                <select class="namespaceSelect" id="namespaceSelectPod" onchange="changeNamespaceSelect()">
                                    <option selected disabled hidden value='' th:text="#{M0869}"></option>
                                </select>
                            </fieldset>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Label Selector</label></dt>
                        <dd>
                            <fieldset>
                                <select class="labelSelect" id="labelSelectPod" onchange="changeLabelSelect()">
                                    <option selected value='' th:text="#{M0870}"></option>
                                </select>
                            </fieldset>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Preview of Pods to be injected</label></dt>
                        <dd>
                            <div class="table_style01">
                                <table>
                                    <caption>Pod List</caption>
                                    <colgroup >
                                        <col width="12%" />
                                        <col width="38%" />
                                        <col width="30%" />
                                        <col width="20%" />
                                    </colgroup>
                                    <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Namespace</th>
                                        <th scope="col">State</th>
                                    </tr>
                                    </thead>
                                    <tbody class="podList" id="podListPod">
                                    </tbody>
                                </table>
                            </div>
                        </dd>
                    </dl>
                    <!-- btn -->
                    <div class="btn02">
                        <div>
                            <button type="submit" id="savePod" th:text="#{M0030}"></button>
                            <button onclick="movePage(URI_CP_GLOBAL_CLUSTER);" th:text="#{M0028}"></button>
                        </div>
                    </div>
                </div>
                <!-- Network Attack-->
                <div>
                    <dl>
                        <dt><label for="nameNetwork">Name</label></dt>
                        <dd>
                            <input class="name" id="nameNetwork" type="text"  th:placeholder="#{M0876}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="latency">Latency</label></dt>
                        <dd>
                            <input id="latency" type="text"  th:placeholder="#{M0871}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="jitter">Jitter</label></dt>
                        <dd>
                            <input id="jitter" type="text"  th:placeholder="#{M0872}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="correlation">Correlation</label></dt>
                        <dd>
                            <input id="correlation" type="text"  th:placeholder="#{M0873}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="direction">Direction</label></dt>
                        <dd>
                            <input id="direction" type="text"  th:placeholder="#{M0874}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="externalTargets">External targets</label></dt>
                        <dd>
                            <input id="externalTargets" type="text"  th:placeholder="#{M0875}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="durationNetwork">Duration</label></dt>
                        <dd>
                            <input id="durationNetwork" type="text"  th:placeholder="#{M0877}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Namespace Selector</label></dt>
                        <dd>
                            <fieldset>
                                <select class="namespaceSelect" id="namespaceSelectNetwork" onchange="changeNamespaceSelect()">
                                    <option selected disabled hidden value='' th:text="#{M0869}"></option>
                                </select>
                            </fieldset>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Label Selector</label></dt>
                        <dd>
                            <fieldset>
                                <select class="labelSelect" id="labelSelectNetwork" onchange="changeLabelSelect()">
                                    <option selected value='' th:text="#{M0870}"></option>
                                </select>
                            </fieldset>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Preview of Pods to be injected</label></dt>
                        <dd>
                            <div class="table_style01">
                                <table>
                                    <caption>Pod List</caption>
                                    <colgroup >
                                        <col width="12%" />
                                        <col width="38%" />
                                        <col width="30%" />
                                        <col width="20%" />
                                    </colgroup>
                                    <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Namespace</th>
                                        <th scope="col">State</th>
                                    </tr>
                                    </thead>
                                    <tbody class="podList" id="podListNetwork">
                                    </tbody>
                                </table>
                            </div>
                        </dd>
                    </dl>
                    <!-- btn -->
                    <div class="btn02">
                        <div>
                            <button type="submit" id="saveNetwork" th:text="#{M0030}"></button>
                            <button onclick="movePage(URI_CP_GLOBAL_CLUSTER);" th:text="#{M0028}"></button>
                        </div>
                    </div>
                </div>
                <!-- Stress Test-->
                <div>
                    <dl>
                        <dt><label for="nameStress">Name</label></dt>
                        <dd>
                            <input class="name" id="nameStress" type="text"  th:placeholder="#{M0876}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="cpuWorkers">CPU Workers</label></dt>
                        <dd>
                            <input id="cpuWorkers" type="text"  th:placeholder="#{M0878}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="load">CPU Load</label></dt>
                        <dd>
                            <input id="load" type="text"  th:placeholder="#{M0879}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="memoryWorkers">Memory Workers</label></dt>
                        <dd>
                            <input id="memoryWorkers" type="text"  th:placeholder="#{M0881}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="size">Memory Size</label></dt>
                        <dd>
                            <input id="size" type="text"  th:placeholder="#{M0882}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label for="durationStress">Duration</label></dt>
                        <dd>
                            <input id="durationStress" type="text"  th:placeholder="#{M0877}"/>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Namespace Selector</label></dt>
                        <dd>
                            <fieldset>
                                <select class="namespaceSelect" id="namespaceSelectStress" onchange="changeNamespaceSelect()">
                                    <option selected disabled hidden value='' th:text="#{M0869}"></option>
                                </select>
                            </fieldset>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Label Selector</label></dt>
                        <dd>
                            <fieldset>
                                <select class="labelSelect" id="labelSelectStress" onchange="changeLabelSelect()">
                                    <option selected value='' th:text="#{M0870}"></option>
                                </select>
                            </fieldset>
                        </dd>
                    </dl>
                    <dl>
                        <dt><label>Preview of Pods to be injected</label></dt>
                        <dd>
                            <div class="table_style01">
                                <table>
                                    <caption>Pod List</caption>
                                    <colgroup >
                                        <col width="12%" />
                                        <col width="38%" />
                                        <col width="30%" />
                                        <col width="20%" />
                                    </colgroup>
                                    <thead>
                                    <tr>
                                        <th scope="col"></th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Namespace</th>
                                        <th scope="col">State</th>
                                    </tr>
                                    </thead>
                                    <tbody class="podList" id="podListStress">
                                    </tbody>
                                </table>
                            </div>
                        </dd>
                    </dl>
                    <!-- btn -->
                    <div class="btn02">
                        <div>
                            <button type="submit" id="saveStress" th:text="#{M0030}"></button>
                            <button onclick="movePage(URI_CP_GLOBAL_CLUSTER);" th:text="#{M0028}"></button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- // tab content -->
        </article>
    </div>
</div>

<th:block layout:fragment="script">
    <script type="text/javascript">
        let tabs = document.querySelector('.tab-btn');
        let tabBtns = document.querySelectorAll('.tab-btn li');
        let tabContent = document.querySelectorAll('.tab-content > div');
        let tabIndex = 0;

        tabBtns[0].classList.add('active');

        for (let i = 0; i < tabBtns.length; i ++) {
            (function(idx) {
                tabBtns[idx].onclick = function() {
                    tabIndex = idx;
                    for( let j=0; j<tabBtns.length; j++ ) {
                        tabBtns[j].classList.remove('active');
                        tabContent[j].style.display = 'none'
                        func.removeHtml(document.getElementsByClassName('namespaceSelect')[j]);
                        func.removeHtml(document.getElementsByClassName('labelSelect')[j]);
                        func.removeHtml(document.getElementsByClassName('podList')[j]);
                    }
                    tabBtns[idx].classList.add('active');
                    tabContent[idx].style.display = '';
                    init();
                };
                tabContent[idx].style.display = 'none';
                tabContent[0].style.display = ''
                init();
            })(i);
        }

        window.onload = () => {
            func.init(ASIDE_DP1.FAULTINJECTION, ASIDE_DP2.EXPERIMENTS);
        }

        function init() {
            func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/users/namespacesList`, 'application/json', namespaceSelector);
        }

        function namespaceSelector(data) {
            let namespaceSelect = `<option selected hidden value='' >${NAMESPACESELECT}</option>`;
            let labelSelect = `<option selected hidden value='' >${LABELSELECT}</option>`;
            for (let i = 0; i < data.items.length; i++) {
                if(data.items[i].cpNamespace === 'ALL') continue;
                namespaceSelect += `<option value="${data.items[i].cpNamespace}">${data.items[i].cpNamespace}</option>`;
            }

            func.appendHtml(document.getElementsByClassName('namespaceSelect')[tabIndex], namespaceSelect);
            func.appendHtml(document.getElementsByClassName('labelSelect')[tabIndex], labelSelect);

        }

        function changeNamespaceSelect() {
            func.removeHtml(document.getElementsByClassName('labelSelect')[tabIndex]);
            func.removeHtml(document.getElementsByClassName('podList')[tabIndex]);

            let namespaceSelect = document.getElementsByClassName('namespaceSelect')[tabIndex].value;
            func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${namespaceSelect}/pods`, 'application/json', labelSelector);
        }

        function labelSelector(data) {

            let labelSelectors = {};
            for(let i = 0; i < data.items.length; i++) {
                const labels = data.items[i].labels
                for(let key in data.items[i].labels){
                    labelSelectors[key] = labels[key];
                }
            }

            let labelSelect = `<option selected hidden value='' >${LABELSELECT}</option><option value='all' >All</option>`;
            for(let key in labelSelectors) {
                labelSelect += `<option value="${key}:${labelSelectors[key]}">${key}:${labelSelectors[key]}</option>`;
            }
            func.appendHtml(document.getElementsByClassName('labelSelect')[tabIndex], labelSelect);

        }

        let labelSelectValue;
        function changeLabelSelect() {
            func.removeHtml(document.getElementsByClassName('podList')[tabIndex]);

            let podName = document.getElementsByClassName('namespaceSelect')[tabIndex].value;
            labelSelectValue = document.getElementsByClassName('labelSelect')[tabIndex].value;
            func.loadData('GET', `${func.url}clusters/${sessionStorage.getItem('cluster')}/namespaces/${podName}/pods`, 'application/json', podList);
        }

        function podList(data) {
            let html = '';
            labelSelectValue = labelSelectValue.split(':')[0]

            for (let i = 0; i < data.items.length; i++) {
                const dataLabels = data.items[i].labels;
                    if(Object.keys(dataLabels).includes(labelSelectValue)) {
                        html += `<tr>
                                      <td>
                                        <input type="checkbox" id="check_${data.items[i].name}" name="check_${data.items[i].name}" value=${data.items[i].name} />
                                        <label for="check_${data.items[i].name}"></label>
                                      </td>
                                      <td id=${data.items[i].name}>${data.items[i].name}</td>
                                      <td id=${data.items[i].namespace}>${data.items[i].namespace}</td>
                                      <td id=${data.items[i].podStatus}>${data.items[i].podStatus}</td>
                                    </tr>`;
                    }
                    if(labelSelectValue === 'all') {
                        html += `<tr>
                                      <td>
                                        <input type="checkbox" id="check_${data.items[i].name}" name="check_${data.items[i].name}" value=${data.items[i].name} />
                                        <label for="check_${data.items[i].name}"></label>
                                      </td>
                                      <td id=${data.items[i].name}>${data.items[i].name}</td>
                                      <td id=${data.items[i].namespace}>${data.items[i].namespace}</td>
                                      <td id=${data.items[i].podStatus}>${data.items[i].podStatus}</td>
                                    </tr>`;
                    }
            }
            func.appendHtml(document.getElementsByClassName("podList")[tabIndex], html, "tbody",);
        }

        function validCheck(){
            if(isEmpty(document.getElementsByClassName('name')[tabIndex].value)) {
                func.alertPopup('ERROR', MSG_REQUEST_VALUE_IS_MISSING, true, MSG_CLOSE, validReset);
                IS_VCHK = true;
                return false;
            }

            if(isEmpty(document.getElementsByClassName('namespaceSelect')[tabIndex].value)) {
                func.alertPopup('ERROR', MSG_REQUEST_VALUE_IS_MISSING, true, MSG_CLOSE, validReset);
                IS_VCHK = true;
                return false;
            }

            if(isEmpty(document.getElementsByClassName('labelSelect')[tabIndex].value)) {
                func.alertPopup('ERROR', MSG_REQUEST_VALUE_IS_MISSING, true, MSG_CLOSE, validReset);
                IS_VCHK = true;
                return false;
            }

            if(isEmpty(document.getElementsByClassName('podList')[tabIndex].value)) {
                func.alertPopup('ERROR', MSG_REQUEST_VALUE_IS_MISSING, true, MSG_CLOSE, validReset);
                IS_VCHK = true;
                return false;
            }



            return true;
        }

        function validReset(){
            IS_VCHK = false;
        }

        function save() {
            let createType = document.querySelector('.tab-btn li.active').getAttribute('type');
            let arg;

            if(validCheck()){

                switch(createType) {
                    case 'podFault':
                        arg = {
                            "cluster" : document.getElementById('createName').value,
                            "resourceName": document.getElementById('createName').value,
                            "providerType": document.getElementById('createProvider').value,
                            "sshKey": document.getElementById('createSshKeys').value,
                            "cloudAccountId": createClusters.getCloudAccount(),
                            "hclScript": document.getElementById('createTemplatesDetail').value,
                            "description": document.getElementById('createDescription').value,
                            "isClusterRegister": false
                        }
                        break;
                    case 'networkAttack':
                        arg = {
                            "cluster": document.getElementById('registerName').value,
                            "resourceName": document.getElementById('registerName').value,
                            "clusterApiUrl": document.getElementById('registerIP').value,
                            "providerType": document.getElementById('registerProvider').value,
                            "clusterToken": document.getElementById('registerCredentials').value,
                            "description": document.getElementById('registerDescription').value,
                            "isClusterRegister": true
                        }
                    case 'stressTest':
                        arg = {
                            "cluster": document.getElementById('registerName').value,
                            "resourceName": document.getElementById('registerName').value,
                            "clusterApiUrl": document.getElementById('registerIP').value,
                            "providerType": document.getElementById('registerProvider').value,
                            "clusterToken": document.getElementById('registerCredentials').value,
                            "description": document.getElementById('registerDescription').value,
                            "isClusterRegister": true
                        }
                }
                //check FILE
                func.saveData('POST', `${func.url}clusters`, JSON.stringify(arg), true, 'application/json', createClusters.saveComp);
            }
        }

    </script>
</th:block>
</html>