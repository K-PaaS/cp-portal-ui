<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<div layout:fragment="content">
    <div id="content" class="sub-page">
        <article class="location">
            <ul>
                <li><a onclick="movePage(URI_CP_CHAOS_EXPERIMENTS)">Chaos</a></li>
                <li><a onclick="movePage(URI_CP_CHAOS_EXPERIMENTS)">Experiments</a></li>
            </ul>
        </article>
        <article class="base detail">
            <div class="notice">
                <div class="chaosChart" id="chaosChart"></div>
                <h4>Details</h4>
                <div class="table_style01">
                    <table>
                        <caption>Details</caption>
                        <colgroup>
                            <col width="20%"/>
                            <col width="80%"/>
                        </colgroup>
                        <tbody class="listTable">
                        <tr>
                            <th scope="row" class="left">Name</th>
                            <td class="left" id="name"></td>
                        </tr>
                        <tr>
                            <th scope="row" class="left">Status</th>
                            <td class="left" id="status"></td>
                        </tr>
                        <tr>
                            <th scope="row" class="left">UUID</th>
                            <td class="left" id="uid"></td>
                        </tr>
                        <tr>
                            <th scope="row" class="left">Namespaces</th>
                            <td class="left" id="namespace"></td>
                        </tr>
                        <tr>
                            <th scope="row" class="left">Created time</th>
                            <td class="left" id="createdTime"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <h4>Scope</h4>
                <div class="table_style01">
                    <table>
                        <caption>Scope</caption>
                        <colgroup>
                            <col width="20%"/>
                            <col width="80%"/>
                        </colgroup>
                        <tbody class="listTable">
                        <tr>
                            <th scope="row" class="left">Namespace Selector</th>
                            <td class="left" id="namespaceSelector"></td>
                        </tr>
                        <tr>
                            <th scope="row" class="left">Label Selectors</th>
                            <td class="left box" id="labelSelectors"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <h4>Experiment</h4>
                <div class="table_style01">
                    <table>
                        <caption>Experiment</caption>
                        <colgroup>
                            <col width="20%"/>
                            <col width="80%"/>
                        </colgroup>
                        <tbody class="listTable" id="experiment">
                        <tr>
                            <th scope="row" class="left">Kind</th>
                            <td class="left" id="kind"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <h4>Run</h4>
                <div class="table_style01">
                    <table>
                        <caption>Run</caption>
                        <colgroup>
                            <col width="20%"/>
                            <col width="80%"/>
                        </colgroup>
                        <tbody class="listTable" id="run">
                        <tr>
                            <th scope="row" class="left">Duration</th>
                            <td class="left" id="duration"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <h4>Events</h4>
                <div class="table_style01">
                    <table class="eventTable">
                        <caption>Events</caption>
                        <colgroup>
                            <col width="80%"/>
                            <col width="20%"/>
                        </colgroup>
                        <thead>
                        <tr>
                            <th scope="col">Message</th>
                            <th scope="col">Event Time</th>
                        </tr>
                        </thead>
                        <tbody class="scrollTableList">
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- btn -->
            <div class="btn02">
                <button type="submit" id="delete" th:text="#{M0026}"></button>
                <div>
                    <a onclick="movePage(URI_CP_CHAOS_EXPERIMENTS)" th:text="#{M0028}"></a>
                </div>
            </div>
        </article>
    </div>
</div>
<div layout:fragment="modal">
    <div class="modal-wrap" style="display:none;">
        <div class="modal">
            <h5 th:text="#{M0034}"></h5>
            <p th:text="#{M0018}"></p>
            <button class="confirm" type="submit" th:text="#{M0026}"></button>
            <a class="close" href="javascript:;" th:text="#{M0023}"></a>
        </div>
    </div>
</div>
<th:block layout:fragment="script">
    <!-- ChartJS -->
    <script src="/plugins/chart.js-3.8.0/package/dist/chart.min.js"></script>
    <script type="text/javascript">
        window.onload = () => {
            func.init(ASIDE_DP1.CHAOS, ASIDE_DP2.EXPERIMENTS);
            const experimentsDetail = {
                statusList: [sessionStorage.getItem('uid')],
                init() {
                    // experimentsDetail 정보 조회
                    func.loadData('GET', `${func.chaosUrl}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('chaosNamespace')}/experiments/${sessionStorage.getItem('kind')}/${sessionStorage.getItem('name')}`, 'application/json', experimentsDetail.draw);
                },

                draw(data) {

                    // Details data
                    document.getElementById('name').innerText = sessionStorage.getItem('name');
                    document.getElementById('uid').innerText = sessionStorage.getItem('uid');
                    document.getElementById('namespace').innerHTML = sessionStorage.getItem('chaosNamespace');
                    document.getElementById('createdTime').innerText = data.items[0].metadata.creationTimestamp.replace('T', ' ').replace('Z', '');

                    let experimentStatus = sessionStorage.getItem('status').toLowerCase();

                    if (experimentStatus === 'deleting' || experimentStatus === 'injecting' || experimentStatus === 'running') {
                        document.getElementById('status').innerHTML = '<span class="left experiment-' + experimentStatus + '"><span class="lds-ring"><span></span><span></span><span></span><span></span></span>' + experimentStatus.charAt(0).toUpperCase() + experimentStatus.slice(1) + '</span>';
                    } else {
                        document.getElementById('status').innerHTML = '<span class="left experiment-' + experimentStatus + '"><span class="lds-circle"><span></span></span>' + experimentStatus.charAt(0).toUpperCase() + experimentStatus.slice(1) + '</span>';
                    }

                    // Scope
                    document.getElementById('namespaceSelector').innerText = data.items[0].spec.selector.namespaces[0];

                    const labelSelectors = data.items[0].spec.selector.labelSelectors;


                    if (labelSelectors !== null) {
                        for (let i = 0; i <= Object.getOwnPropertyNames(labelSelectors).length - 1; i++) {
                            let html = `<dl><dt>${Object.getOwnPropertyNames(labelSelectors)[i]}</dt><dd>${labelSelectors[Object.keys(labelSelectors)[i]]}</dd></dl>`;
                            func.appendHtml(document.getElementById('labelSelectors'), html, 'dl');
                        }
                    } else {
                        let html = `<dl>-</dl>`;
                        func.appendHtml(document.getElementById('labelSelectors'), html, 'dl');
                    }

                    // Experiment
                    document.getElementById('kind').innerHTML = data.items[0].kind;

                    if (data.items[0].kind === 'PodChaos') {
                        const action = data.items[0].spec.action;
                        const gracePeriod = data.items[0].spec.gracePeriod;

                        let html = `<tr><th scope="row" class="left">Action</th><td class="left" id="action">${action}</td></tr>`;
                        html += `<tr><th scope="row" class="left">Grace Period</th><td class="left" id="gracePeriod">${gracePeriod}</td></tr>`;
                        func.appendHtml(document.getElementById('experiment'), html, 'tbody');


                    }
                    if (data.items[0].kind === 'NetworkChaos') {
                        const action = data.items[0].spec.action;

                        let html = `<tr><th scope="row" class="left">Action</th><td class="left" id="action">${action}</td></tr>`;
                        func.appendHtml(document.getElementById('experiment'), html, 'tbody');


                    }

                    if (data.items[0].kind === 'StressChaos') {
                        // draw chart
                        experimentsDetail.drawChart();

                        // CPU, Memory, App 정상 여부 조회
                        // func.loadData('GET', `https://run.mocky.io/v3/72c2f391-c91c-450b-abf9-47f28500ba6a`, 'application/json', experimentsDetail.chart);
                        func.loadData('GET', `${func.chaosUrl}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/experiments/resourceUsage`, 'application/json', experimentsDetail.chart);


                        if (data.items[0].spec.stressors.memory != null) {
                            const memoryObj = data.items[0].spec.stressors.memory;

                            let html1 = `<tr><th scope="row" class="left">Memory</th><td class="left" id="memory"></td></tr>`;
                            func.appendHtml(document.getElementById('experiment'), html1, 'tbody');

                            let memory = '';
                            for (let i = 0; i <= Object.getOwnPropertyNames(memoryObj).length - 1; i++) {
                                if (Object.getOwnPropertyNames(memoryObj)[i] !== 'oomScoreAdj') {
                                    memory += Object.getOwnPropertyNames(memoryObj)[i] + ": " + memoryObj[Object.keys(memoryObj)[i]] + "\n";
                                }
                            }
                            document.getElementById('memory').innerText = memory;
                        }

                        if (data.items[0].spec.stressors.cpu != null) {
                            const cpuObj = data.items[0].spec.stressors.cpu;

                            let html2 = `<tr><th scope="row" class="left">CPU</th><td class="left" id="cpu"></td></tr>`;
                            func.appendHtml(document.getElementById('experiment'), html2, 'tbody');

                            let cpu = '';
                            for (let i = 0; i <= Object.getOwnPropertyNames(cpuObj).length - 1; i++) {
                                cpu += Object.getOwnPropertyNames(cpuObj)[i] + ": " + cpuObj[Object.keys(cpuObj)[i]] + "\n";
                            }
                            document.getElementById('cpu').innerText = cpu;
                        }
                    }

                    // Run
                    const duration = data.items[0].spec.duration;

                    if (duration === null) {
                        document.getElementById('duration').innerHTML = 'Run continuously';
                    }
                    if (duration) {
                        document.getElementById('duration').innerHTML = duration;
                    }

                    // event 정보 조회
                    func.loadData('GET', `${func.chaosUrl}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/experiments/events?event=True&object_id=${sessionStorage.getItem('uid')}&limit=999`, 'application/json', experimentsDetail.list);

                    experimentsDetail.event();

                },

                list(data) {

                    func.removeHtml(document.querySelector('.scrollTableList'));

                    if (data.items.length > 0) {
                        for (let i = 0; i <= data.items.length - 1; i++) {
                            let name = data.items[i].name.split('.')[0];
                            let createdTime = data.items[i].created_at.replace('T', ' ').replace('Z', '');

                            if (name === sessionStorage.getItem('name')) {
                                let html = `<tr>
                                    <td class="left eventFirstColumn">${data.items[i].message}</td>
                                    <td>${createdTime}</td>
                                </tr>`;
                                func.appendHtml(document.querySelector('.scrollTableList'), html, 'tbody');
                            }

                        }
                        ;
                    } else {
                        let html = '<tr><td rowspan="2">No Data.</td></tr>';

                        func.appendHtml(document.querySelector('.scrollTableList'), html, 'tbody');
                    }
                    ;
                },

                drawChart() {
                    document.getElementById('chaosChart').innerHTML = `
                        <h4>Resource usage during chaos</h4>
                        <ul>
                            <li>
                                <div>
                                    <canvas id="cpuMemChart" style="height: 250px; max-width: 100%; max-height: 100%;"></canvas>
                                </div>
                            </li>
                            <li>
                                <div>
                                    <canvas id="appStatusChart" style="height: 250px; max-width: 100%; max-height: 100%;"></canvas>
                                </div>
                            </li>
                        </ul>
                    `
                },

                chart(data) {
                    let labels = [];
                    let cpuRatio = [];
                    let memRatio = [];
                    let appStatus = [];

                    for (let i = 0; i < data.items.length; i++) {
                        labels.push(data.items[i].measurementTime.replace(/.*T(\d{2}:\d{2}:\d{2}).*/, '$1'));
                        cpuRatio.push(data.items[i].cpuRatio)
                        memRatio.push(data.items[i].memRatio)
                        appStatus.push(data.items[i].appStatus === 1 ? '정상' : '비정상' )
                    }

                    const dataId = ['cpuMemChart', 'appStatusChart'];

                    let dataSets;
                    let config;

                    for(var i = 0; i < dataId.length; i++){
                        if(dataId[i] === 'cpuMemChart') {
                            dataSets = {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'CPU(%)',
                                        data: cpuRatio,
                                        borderColor: 'RGB(255, 99, 132)',
                                        backgroundColor: 'RGB(255, 177, 193)',
                                    },
                                    {
                                        label: 'Memory(%)',
                                        data: memRatio,
                                        borderColor: 'RGB(54, 162, 235)',
                                        backgroundColor: 'RGB(154, 208, 245)',
                                    }
                                ]
                            };

                            config = {
                                type: 'line',
                                data: dataSets,
                                options: {
                                    responsive: true,
                                    scales: {
                                        y: {
                                            type: 'linear',
                                            position: 'left',
                                            stack: 'demo',
                                            stackWeight: 1,
                                            min: 0,
                                            max: 100,
                                            ticks: {
                                                stepSize: 1
                                            }
                                        }
                                    }
                                },
                            };
                            new Chart(
                                document.getElementById(dataId[i]),
                                config
                            );
                        }
                        if(dataId[i] === 'appStatusChart'){
                            dataSets = {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'APP Status',
                                        data: appStatus,
                                        borderColor: 'RGB(75, 192, 192)',
                                        backgroundColor: 'RGB(165, 223, 223)',
                                        stepped: true,
                                    }
                                ]
                            };

                            config = {
                                type: 'line',
                                data: dataSets,
                                options: {
                                    responsive: true,
                                    scales: {
                                        y: {
                                            type: 'category',
                                            labels: ['정상', '비정상'],
                                            offset: true,
                                            position: 'left',
                                            stack: 'demo',
                                            stackWeight: 1,
                                        }
                                    }
                                },
                            };
                            new Chart(
                                document.getElementById(dataId[i]),
                                config
                            );
                        }
                    }

                },

                event() {
                    document.getElementById('delete').addEventListener('click', (e) => {
                        func.alertPopup('DELETE', MSG_CHECK_TO_DELETE, true, MSG_CONFIRM, experimentsDetail.delete);
                    }, false);

                    setInterval(experimentsDetail.statusInterval, 1200);
                },

                statusInterval() {
                    // detail status 정보 조회
                    func.loadData('GET', `${func.chaosUrl}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('nameSpace')}/experiments/status/${sessionStorage.getItem('uid')}`, 'application/json', experimentsDetail.status);
                },

                status(data) {
                    let experimentStatus = data.status;

                    if (experimentStatus === 'finished') {
                        experimentStatus = 'completed'
                    }

                    if (experimentStatus === 'deleting' || experimentStatus === 'injecting' || experimentStatus === 'running') {
                        document.getElementById('status').innerHTML = '<span class="left experiment-' + experimentStatus + '"><span class="lds-ring"><span></span><span></span><span></span><span></span></span>' + experimentStatus.charAt(0).toUpperCase() + experimentStatus.slice(1) + '</span>';
                    } else {
                        document.getElementById('status').innerHTML = '<span class="left experiment-' + experimentStatus + '"><span class="lds-circle"><span></span></span>' + experimentStatus.charAt(0).toUpperCase() + experimentStatus.slice(1) + '</span>';
                    }
                },

                delete() {

                    func.saveData('DELETE', `${func.chaosUrl}clusters/${sessionStorage.getItem('cluster')}/namespaces/${sessionStorage.getItem('chaosNamespace')}/experiments/${sessionStorage.getItem('kind')}/${sessionStorage.getItem('name')}`, '', true, 'application/json', func.historyBack);
                },
            }
            experimentsDetail.init();
        }
    </script>
</th:block>
</html>
